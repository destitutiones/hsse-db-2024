# Материалы

- [Лекция 4](https://drive.google.com/file/d/1fDmQ2LPY21pUXBQDRxYpmCh-ATXeu7sV/view?usp=sharing)
- [Туториал](https://www.tutorialsteacher.com/postgresql/identity-column) по identity-column.

# Теория

## Проектирование

### Основные этапы проектирования

Рассматриваем на примере проектирования БД гитарного магазина.

#### Концептуальное проектирование

1. Определяем предметную область, с которой будем работать. Например, предметная область ритейла.
2. Разбиваем на не детализированные сущности. Например, чек покупки, продукт, магазин, ассортиментная матрица и т.д.
3. Определяем, как сущности будут друг с другом связаны: один к одному, один ко многим и т.д.
4. Строим визуальную картину в ER-нотации "Воронья лапка" (Crow's Foot) _без явных атрибутов_.

**Пример результата:**

<img src='./img/img0_concept.png' width='700'>

#### Логическое проектирование

1. Разбиваем сущности из этапа концептуального проектирования на детализированные согласно выбранной модели данных и нормализации.
2. Определяем атрибуты, связи между сущностями по атрибутам.
3. Строим визуальную картину в ER-нотации "Воронья лапка" (Crow's Foot) _с явными атрибутами_.

**Пример результата:**

<img src='./img/img1_logical.png' width='700'>

#### Физическое проектирование

1. Создаем логическую схему базы данных для конкретной СУБД.
2. Учитываем возможные ограничения на именование объектов базы данных, поддерживаемые типы данных и т.п.
3. Пишем SQL-скрипт с созданием таблиц с учётом всех заявленных ограничений или детальную таблицу-образец для дальнейшего написания скриптов.

**Пример результата в виде таблицы:**

*Note.* Вместо `VARCHAR(255)` предпочтительнее использовать `TEXT`, а вместо `SERIAL` – `identity-column` (см. материалы в самом начале).

<img src='./img/img2_physical.png' width='700'>

### Нотация "Воронья лапка"

* Сущность изображается в виде прямоугольника, содержащего ее имя.
* Атрибуты сущности (для логической модели) записываются внутри прямоугольника, изображающего сущность.
* Связь изображается линией, которая соединяет две сущности, участвующие в отношении.
* Описания связей выглядят следующим образом:

<img src='./img/img3_er_notation.png' width='700'>

### Нормализация

**Нормализацией БД** называют приведение БД к нормальной форме.

**Нормальная форма**:
- совокупность требований, которым должно удовлетворять отношение для уменьшения вероятности возникновения аномалий;
- свойство отношения в реляционной модели данных, характеризующее его с точки зрения избыточности, потенциально приводящей к логически ошибочным результатам выборки или изменениям данных.

**Для чего нормализация предназначена:**

- Минимизация логической избыточности.
- Уменьшение потенциальной противоречивости.
- Исключение некоторых типов избыточности.
- Устранение некоторых аномалий обновления.

**Для чего нормализация не предназначена:**
- Уменьшение/увеличение производительности или физического объема БД.

#### Определения

- *Декомпозиция* – разложение исходной переменной отношения на несколько эквивалентных. Обратимая декомпозиция называется *декомпозицией без потерь* или *правильной*. 
- *Аномалия* – ситуация в таблице БД, которая приводит к противоречию в БД либо существенно усложняет обработку БД. Причиной является излишнее дублирование данных в таблице, которое вызывается наличием функциональных зависимостей от не ключевых атрибутов. 
- *Функциональная зависимость* между множествами атрибутов **A** и **B** означает, что для любого допустимого набора кортежей в данном отношении верно следующее: если два кортежа совпадают по значению **A**, то они совпадают по значению **B**.
- *Минимальная функциональная зависимость* означает, что в составе первичного ключа отсутствует меньшее подмножество атрибутов, от которого можно также вывести данную функциональную зависимость.

#### Нормальная форма 1 (1НФ)

Переменная отношения находится в **первой нормальной форме** тогда и только тогда, когда в любом допустимом значении этой переменной отношения каждый её кортеж содержит только одно значение для каждого из атрибутов. **tl;dr** все атрибуты скалярные.

**Пример отношения:**

| S#  | SNAME  | CITY   | 	P#                       | QTY                            |
|-----|--------|--------|---------------------------|--------------------------------|
| S1  | Smith  | London | 	[P1, P2, P3, P4, P5, P6] | [300, 200, 400, 200, 100, 100] |
| S2  | Jones  | Paris  | 	[P1, P2, P3]             | [300, 400, 200]                |
| S4  | Clark  | London | 	[P2, P4, P5]             | [200, 300, 400]                |

**Отношение в 1НФ:**

| S#  | 	SNAME	 | CITY    | 	P#  | 	QTY |
|-----|---------|---------|------|------|
| S1  | 	Smith  | 	London | 	P1  | 	300 |
| S1  | 	Smith  | 	London | 	P2  | 	200 |
| S1  | 	Smith  | 	London | 	P3  | 	400 |
| S1  | 	Smith  | 	London | 	P4  | 	200 |
| S1  | 	Smith  | 	London | 	P5  | 	100 |
| S1  | 	Smith  | 	London | 	P6  | 	100 |
| S2	 | Jones	  | Paris   | 	P1  | 	300 |
| S2	 | Jones	  | Paris   | 	P2  | 	400 |
| S2	 | Jones	  | Paris   | 	P2	 | 200  |
| S4	 | Clark	  | London  | 	P3	 | 200  |
| S4	 | Clark	  | London  | 	P4	 | 300  |
| S4	 | Clark	  | London  | 	P5	 | 400  |

**Определения:**
* Пусть X и Y – произвольные подмножества множества атрибутов отношения R. Тогда **Y функционально зависимо от X** (X $\rightarrow$ Y) тогда и только тогда, когда каждое значение множества X отношения R связано точно с одним значением множества Y отношения R.
В этом случае X называют детерминантом, а Y – зависимой частью.
* Функциональная зависимость называется **тривиальной**, если зависимая часть является подмножеством детерминанта.
* **Неприводимость** означает, что в составе потенциального ключа отсутствует меньшее подмножество атрибутов, от которого можно также вывести данную функциональную зависимость.

**Какие функциональные зависимости наблюдаем в отношении выше?**


<details>
  <summary>Примеры функциональных зависимостей</summary>

* {S#} $\rightarrow$ {SNAME} – неприводимая зависимость.
* {S#} $\rightarrow$ {CITY} – неприводимая зависимость.
* {S#, P#} $\rightarrow$ {QTY} – неприводимая зависимость.
* {S#, P#} $\rightarrow$ {#S} – тривиальная зависимость.
* {S#, SNAME, P#} $\rightarrow$ {CITY}

</details>

#### Нормальная форма 2 (2НФ)

Переменная отношения находится во **второй нормальной форме** тогда и только тогда, когда она находится в первой нормальной форме и каждый неключевой атрибут _неприводимо_ зависит от его первичного ключа.

**Пример отношения:**

| S#  | 	STATUS	 | CITY    | 	P#  | 	QTY |
|-----|----------|---------|------|------|
| S1  | 	20      | 	London | 	P1  | 	300 |
| S1  | 	20      | 	London | 	P2  | 	200 |
| S1  | 	20      | 	London | 	P3  | 	400 |
| S1  | 	20      | 	London | 	P4  | 	200 |
| S1  | 	20      | 	London | 	P5  | 	100 |
| S1  | 	20      | 	London | 	P6  | 	100 |
| S2	 | 10	      | Paris   | 	P1  | 	300 |
| S2	 | 10	      | Paris   | 	P2  | 	400 |
| S2	 | 10	      | Paris   | 	P2	 | 200  |
| S4	 | 20	      | London  | 	P3	 | 200  |
| S4	 | 20	      | London  | 	P4	 | 300  |
| S4	 | 20	      | London  | 	P5	 | 400  |


**Диаграмма зависимостей**

<img src='./img/img4_supply_diagram_2nf.png' width='700'>

**Отношение во 2НФ**

Производим декомпозицию.

_Suppliers_

| S#  | 	STATUS	 | CITY    |
|-----|----------|---------|
| S1  | 	20      | 	London |
| S2	 | 10	      | Paris   |
| S3	 | 10	      | Paris   |
| S4	 | 20	      | London  |
| S5	 | 30	      | Athens  |

_SP_

| S#   | 	P#  | 	QTY |
|------|------|------|
| S1   | 	P1  | 	300 |
| S1   | 	P2  | 	200 |
| S1   | 	P3  | 	400 |
| S1   | 	P4  | 	200 |
| S1   | 	P5  | 	100 |
| S1   | 	P6  | 	100 |
| S2	| 	P1  | 	300 |
| S2	| 	P2  | 	400 |
| S2	| 	P2	 | 200  |
| S4	| 	P3	 | 200  |
| S4	| 	P4	 | 300  |
| S4	| 	P5	 | 400  |

**Обновленная диаграмма зависимостей**

<img src='img/img5_supply_diagram_2nf_new.png' width='700'>

**Все ли аномалии обновления мы решили?**

<details>
  <summary>Ответ</summary>

Нет.

* `INSERT`: Нельзя вставить информацию о том, что определенный город характеризуется некоторым статусом.
* `DELETE`: Если из отношения `Suppliers` удалить кортеж, который является единственным для города, то будет удалена не только информация о поставщике из данного города, но и статус, который соответствует городу.
* `UPDATE`:
  * В переменной отношения `Suppliers` информация о статусе для города повторяется несколько раз. При смене статуса в городе эту информацию нужно менять в нескольких местах.
  * Если статус будет изменен не везде, то база данных будет в несогласованном состоянии.

</details>

**В чем причина?**

<details>
  <summary>Ответ</summary>

Переменная отношения `Suppliers` содержит информацию и о поставщиках, и о городах – произошло смешивание информации.

</details>

#### Нормальная форма 3 (3НФ)

Переменная отношения находится в **третьей нормальной форме** тогда и только тогда, когда она находится во второй нормальной форме и ни один неключевой атрибут не является транзитивно зависимым от ее первичного ключа.

**Текущее состояние схемы. Транзитивная зависимость**

<img src='img/img5_supply_diagram_2nf_new.png' width='700'>

**Отношение в 3НФ:**

_Suppliers_

| S#  	 | CITY    |
|-------|---------|
| S1    | 	London |
| S2    | Paris   |
| S3    | Paris   |
| S4    | London  |
| S5    | Athens  |

_Status_

| CITY   | STATUS  |
|--------|---------|
| London | 20      |
| Paris  | 10      |
| Athens | 30      |
| Rome   | 50      |


_SP_

| S#   | 	P#  | 	QTY |
|------|------|------|
| S1   | 	P1  | 	300 |
| S1   | 	P2  | 	200 |
| S1   | 	P3  | 	400 |
| S1   | 	P4  | 	200 |
| S1   | 	P5  | 	100 |
| S1   | 	P6  | 	100 |
| S2	| 	P1  | 	300 |
| S2	| 	P2  | 	400 |
| S2	| 	P2	 | 200  |
| S4	| 	P3	 | 200  |
| S4	| 	P4	 | 300  |
| S4	| 	P5	 | 400  |


<img src='./img/img6_supply_diagram_3nf.png' width='700'>

**Свойства 3НФ:**
* (+) Позволяет решить проблемы обновлений в большинстве случаев, которые части случаются на практике
* (-) Основывается на допущении, что в каждой переменной отношения только один потенциальный ключ

## Ограничения

